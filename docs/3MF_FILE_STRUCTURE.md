# 3MF File Structure Documentation

## Overview

This document details the complete structure of 3MF files generated by pixel_to_3mf, including all required files, XML schemas, data formats, and implementation decisions that were necessary to create fully functional multi-object 3MF files that work correctly in modern slicers (Bambu Studio, PrusaSlicer, etc.).

A 3MF file is **not a single XML file** - it's a **ZIP archive** containing multiple XML files and binary resources organized in a specific directory structure.

## Table of Contents

1. [Directory Structure](#directory-structure)
2. [Required Files](#required-files)
3. [Optional Files](#optional-files)
4. [XML Namespaces](#xml-namespaces)
5. [Coordinate System](#coordinate-system)
6. [Object Numbering](#object-numbering)
7. [AMS Integration](#ams-integration)
8. [Critical Implementation Details](#critical-implementation-details)

---

## Directory Structure

```text
model.3mf (ZIP archive)
├── [Content_Types].xml           # REQUIRED: File type declarations
├── _rels/
│   └── .rels                      # REQUIRED: Main relationships file
├── 3D/
│   ├── 3dmodel.model             # REQUIRED: Main assembly file
│   ├── Objects/
│   │   └── object_1.model        # REQUIRED: Mesh library (all geometry)
│   └── _rels/
│       └── 3dmodel.model.rels    # REQUIRED: References to object_1.model
├── Metadata/
│   ├── model_settings.config     # REQUIRED: Object names and AMS slots
│   ├── top_1.png                 # OPTIONAL: Top-view thumbnail (512x512)
│   ├── pick_1.png                # OPTIONAL: Silhouette thumbnail (512x512)
│   ├── plate_1.png               # OPTIONAL: Isometric thumbnail (512x512)
│   ├── plate_1_small.png         # OPTIONAL: Small isometric (128x128)
│   └── plate_no_light_1.png      # OPTIONAL: Isometric no lighting (512x512)
```

---

## Required Files

### 1. `[Content_Types].xml`

**Purpose**: Declares MIME types for all file extensions in the archive.

**Location**: Root of ZIP archive

**Key Requirements**:

- Must be named exactly `[Content_Types].xml` (with square brackets)
- Must declare content types for: `.rels`, `.model`, `.png`, `.gcode`

**Example**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" 
           ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="model" 
           ContentType="application/vnd.ms-package.3dmanufacturing-3dmodel+xml"/>
  <Default Extension="png" 
           ContentType="image/png"/>
  <Default Extension="gcode" 
           ContentType="text/x.gcode"/>
</Types>
```

**Critical Details**:

- Without this file, the 3MF won't open in any slicer
- The namespace URI must be exact
- Must include all extensions used in the archive

---

### 2. `_rels/.rels`

**Purpose**: Points to the main 3D model file.

**Location**: `_rels/.rels` (in a `_rels` directory at root)

**Key Requirements**:

- Must exist and point to the main model file
- Uses specific relationship type URI

**Example**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Target="/3D/3dmodel.model" 
                Id="rel-1" 
                Type="http://schemas.microsoft.com/3dmanufacturing/2013/01/3dmodel"/>
</Relationships>
```

**Critical Details**:

- The `Target` path must be absolute (start with `/`)
- The `Type` URI is specific to 3MF specification
- The `Id` can be any unique string (we use "rel-1")

---

### 3. `3D/3dmodel.model`

**Purpose**: Main assembly file that defines the build plate and references mesh objects.

**Location**: `3D/3dmodel.model`

**Key Requirements**:

- Must reference mesh objects from `3D/Objects/object_1.model`
- Defines object placement via transforms
- Contains build plate definition
- Includes metadata (thumbnails, title, etc.)

**Structure**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<model unit="millimeter" 
       xml:lang="en-US" 
       xmlns="http://schemas.microsoft.com/3dmanufacturing/core/2015/02"
       xmlns:BambuStudio="http://schemas.bambulab.com/package/2021"
       xmlns:p="http://schemas.microsoft.com/3dmanufacturing/production/2015/06"
       requiredextensions="p">
  
  <!-- Metadata -->
  <metadata name="Application">PixelTo3MF</metadata>
  <metadata name="BambuStudio:3mfVersion">1</metadata>
  <metadata name="Thumbnail_Middle">/Metadata/plate_1.png</metadata>
  <metadata name="Thumbnail_Small">/Metadata/plate_1_small.png</metadata>
  <metadata name="Title">MyPixelArt</metadata>
  
  <!-- Resources -->
  <resources>
    <!-- Container object that groups all parts -->
    <object id="45" type="model" p:UUID="{unique-uuid-here}">
      <mesh>
        <vertices/>
        <triangles/>
      </mesh>
      
      <!-- Component references to actual mesh objects -->
      <components>
        <component objectid="1" p:path="/3D/Objects/object_1.model" 
                   transform="1 0 0 0 1 0 0 0 1 50 50 0"/>
        <component objectid="2" p:path="/3D/Objects/object_1.model" 
                   transform="1 0 0 0 1 0 0 0 1 51 52 0"/>
        <!-- ... more components ... -->
      </components>
    </object>
  </resources>
  
  <!-- Build definition -->
  <build>
    <item objectid="45" transform="1 0 0 0 1 0 0 0 1 128 128 0"/>
  </build>
</model>
```

**Critical Details**:

1. **Namespaces**: Three required namespaces must be declared
   - Core 3MF: `http://schemas.microsoft.com/3dmanufacturing/core/2015/02`
   - Production: `http://schemas.microsoft.com/3dmanufacturing/production/2015/06`
   - Bambu: `http://schemas.bambulab.com/package/2021`

2. **Container Object Pattern**:
   - Create ONE container object with empty geometry
   - Container object has `<components>` that reference actual meshes
   - Container object ID should be `num_meshes + 1` (highest ID)
   - Each component references mesh from `object_1.model` via `p:path`

3. **Transform Matrix Format**: `"m11 m12 m13 m21 m22 m23 m31 m32 m33 tx ty tz"`
   - Identity rotation: `1 0 0 0 1 0 0 0 1`
   - Translation: last 3 values (tx, ty, tz)
   - Example: `"1 0 0 0 1 0 0 0 1 128 128 0"` = identity rotation + translate to (128, 128, 0)

4. **Build Plate Positioning**:
   - The `<build>` section places the container object
   - Transform should center model on build plate (typically 128, 128 for 256mm bed)
   - Z-offset should be 0 (models sit on build plate)

5. **UUIDs**: Each object should have unique `p:UUID` attribute
   - Format: `{xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx}`
   - Generate with standard UUID libraries

---

### 4. `3D/Objects/object_1.model`

**Purpose**: Mesh library containing all actual 3D geometry.

**Location**: `3D/Objects/object_1.model`

**Key Requirements**:

- Contains ALL mesh objects (one `<object>` element per mesh)
- Each object has unique ID (1, 2, 3, ...)
- Vertices use millimeter units with 3 decimal places
- Triangles reference vertices by 0-based index

**Structure**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<model unit="millimeter" 
       xml:lang="en-US" 
       xmlns="http://schemas.microsoft.com/3dmanufacturing/core/2015/02"
       xmlns:p="http://schemas.microsoft.com/3dmanufacturing/production/2015/06"
       requiredextensions="p">
  
  <resources>
    <!-- Object 1 -->
    <object id="1" p:UUID="{uuid-1}" type="model">
      <mesh>
        <vertices>
          <vertex x="0.000" y="0.000" z="0.000"/>
          <vertex x="1.000" y="0.000" z="0.000"/>
          <vertex x="1.000" y="1.000" z="0.000"/>
          <!-- ... more vertices ... -->
        </vertices>
        <triangles>
          <triangle v1="0" v2="1" v3="2"/>
          <triangle v1="1" v2="3" v3="2"/>
          <!-- ... more triangles ... -->
        </triangles>
      </mesh>
    </object>
    
    <!-- Object 2 -->
    <object id="2" p:UUID="{uuid-2}" type="model">
      <mesh>
        <vertices>
          <!-- vertices for object 2 -->
        </vertices>
        <triangles>
          <!-- triangles for object 2 -->
        </triangles>
      </mesh>
    </object>
    
    <!-- ... more objects ... -->
  </resources>
  
  <!-- Empty build tag (required by spec) -->
  <build/>
</model>
```

**Critical Details**:

1. **Vertex Format**:
   - Attributes: `x`, `y`, `z` (all lowercase)
   - Units: millimeters
   - Precision: 3 decimal places (0.001mm = 1 micron)
   - Strip trailing zeros: "1.500" → "1.5", "2.0" → "2"

2. **Triangle Format**:
   - Attributes: `v1`, `v2`, `v3` (vertex indices)
   - Indices are 0-based (first vertex = 0)
   - Winding order: **Counter-clockwise (CCW)** for outward-facing normals

3. **Object IDs**:
   - Must be sequential: 1, 2, 3, ...
   - Must match IDs used in `3dmodel.model` components
   - Cannot skip numbers

4. **Empty Build Tag**:
   - Must have `<build/>` tag even though this file isn't directly built
   - Spec requirement - file is invalid without it

---

### 5. `3D/_rels/3dmodel.model.rels`

**Purpose**: Declares relationship from main model to mesh library.

**Location**: `3D/_rels/3dmodel.model.rels`

**Key Requirements**:

- Must exist in `_rels` subdirectory within `3D/`
- Points to `object_1.model`

**Example**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Target="/3D/Objects/object_1.model" 
                Id="rel-1" 
                Type="http://schemas.microsoft.com/3dmanufacturing/2013/01/3dmodel"/>
</Relationships>
```

**Critical Details**:

- Path must be absolute (start with `/`)
- Must point to the exact mesh library file location
- Without this, the main model can't find the mesh geometry

---

### 6. `Metadata/model_settings.config`

**Purpose**: Defines object names and AMS (Automatic Material System) extruder assignments.

**Location**: `Metadata/model_settings.config`

**Key Requirements**:

- Maps object IDs to human-readable names
- Assigns extruder slots for multi-material printing
- Defines parent-child relationships for object grouping

**Structure**:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<config>
  <!-- Container object (parent) -->
  <object id="45">
    <metadata key="name" value="PixelArt3D"/>
    
    <!-- Part 1: Red region -->
    <part id="1" subtype="normal_part">
      <metadata key="name" value="Red"/>
      <!-- Slot 1 is default, no extruder metadata needed -->
    </part>
    
    <!-- Part 2: Blue region -->
    <part id="2" subtype="normal_part">
      <metadata key="name" value="Blue"/>
      <metadata key="extruder" value="2"/>
    </part>
    
    <!-- Part 3: Green region -->
    <part id="3" subtype="normal_part">
      <metadata key="name" value="Green"/>
      <metadata key="extruder" value="3"/>
    </part>
    
    <!-- ... more parts ... -->
    
    <!-- Backing plate -->
    <part id="44" subtype="normal_part">
      <metadata key="name" value="Backing"/>
      <!-- Slot 1 is default (backing color) -->
    </part>
  </object>
  
  <!-- Assembly information -->
  <assemble>
    <assemble_item object_id="45" 
                   instance_id="0" 
                   transform="1 0 0 0 1 0 0 0 1 0 0 0" 
                   offset="0 0 0"/>
  </assemble>
</config>
```

**Critical Details**:

1. **Parent Object**:
   - Must be the container object (highest ID)
   - Contains all parts as children
   - Has single `<metadata key="name">` for the assembly

2. **Part Entries**:
   - Each mesh object (except container) is a `<part>`
   - `subtype="normal_part"` is standard
   - `id` must match object ID from `object_1.model`

3. **Name Metadata**:
   - `key="name"` defines what appears in slicer object list
   - Should be the color name or descriptive label
   - **This is how colors are labeled in the slicer UI**

4. **Extruder Metadata**:
   - `key="extruder"` assigns AMS slot (1-16 for Bambu Lab)
   - **Slot 1 is the default** - no metadata needed for slot 1
   - Only add extruder metadata for slots 2 and higher
   - Values: "2", "3", "4", ... "16"

5. **Assemble Section**:
   - Required at root level
   - `object_id` should be container ID
   - `instance_id` typically "0"
   - `transform` is identity matrix
   - `offset` typically "0 0 0"

---

## Optional Files

### Thumbnail Images

**Location**: `Metadata/*.png`

**Supported Thumbnails**:

1. **`top_1.png`** (512x512):
   - Top-down view of the model
   - Scaled source image
   - Maintains aspect ratio with transparent padding

2. **`pick_1.png`** (512x512):
   - Silhouette view (gray where pixels exist)
   - Used for quick visual identification
   - 50% gray (#808080) for filled areas, transparent elsewhere

3. **`plate_1.png`** (512x512):
   - Isometric view (rotated -30°)
   - Most commonly displayed thumbnail
   - Referenced by `Thumbnail_Middle` metadata

4. **`plate_1_small.png`** (128x128):
   - Downscaled isometric view
   - Used in thumbnail lists
   - Referenced by `Thumbnail_Small` metadata

5. **`plate_no_light_1.png`** (512x512):
   - Isometric view without lighting effects
   - Identical to `plate_1.png` in our implementation

**Critical Details**:

- Must be PNG format
- Must use NEAREST resampling for pixel art (no anti-aliasing)
- Aspect ratio must be preserved
- Transparent background recommended
- Thumbnails are optional but highly recommended for better UX

---

## XML Namespaces

### Required Namespaces

```xml
xmlns="http://schemas.microsoft.com/3dmanufacturing/core/2015/02"
xmlns:p="http://schemas.microsoft.com/3dmanufacturing/production/2015/06"
xmlns:BambuStudio="http://schemas.bambulab.com/package/2021"
```

**Usage**:

1. **Core namespace** (default): Used for all standard 3MF elements
   - `<model>`, `<object>`, `<mesh>`, `<vertex>`, `<triangle>`, etc.

2. **Production namespace** (`p:`): Used for extended features
   - `p:UUID` - Unique identifiers for objects
   - `p:path` - References to external model files
   - `requiredextensions="p"` - Declares production extensions are required

3. **Bambu namespace**: Used for Bambu Studio specific features
   - `BambuStudio:3mfVersion` - Version metadata
   - Future Bambu-specific features

**Critical Details**:

- URIs must match exactly (case-sensitive)
- Production namespace must be declared when using `p:` attributes
- Without proper namespaces, slicers may reject the file

---

## Coordinate System

### Units

- **All coordinates**: Millimeters
- **Precision**: 3 decimal places (0.001mm = 1 micron)

### Origin and Axes

```text
    +Y (back)
    |
    |
    |
    +------ +X (right)
   /
  /
+Z (up)
```

- **Origin**: Bottom-left-front corner of model
- **X-axis**: Left to right (width)
- **Y-axis**: Front to back (depth/height in 2D image)
- **Z-axis**: Bottom to top (layer height in 3D)

### Y-Axis Flip

**CRITICAL**: Images have Y=0 at top, 3D models have Y=0 at bottom.

- **Image coordinates**: Origin at top-left, Y increases downward
- **3D coordinates**: Origin at bottom-left, Y increases upward
- **Solution**: Flip image vertically during loading so models appear right-side-up

### Transform Matrices

**Format**: `"m11 m12 m13 m21 m22 m23 m31 m32 m33 tx ty tz"`

**Identity with translation**:

```text
1 0 0   tx
0 1 0   ty  = "1 0 0 0 1 0 0 0 1 tx ty tz"
0 0 1   tz
```

**Common transforms**:

- **Identity**: `"1 0 0 0 1 0 0 0 1 0 0 0"`
- **Translate to center**: `"1 0 0 0 1 0 0 0 1 128 128 0"`
- **Model centering**: `"1 0 0 0 1 0 0 0 1 {model_center_x} {model_center_y} 0"`

---

## Object Numbering

### Mesh Objects

**Numbering scheme**: 1-based, sequential

```text
Object ID 1  = First colored region
Object ID 2  = Second colored region
...
Object ID N  = Last colored region or backing plate
Object ID N+1 = Container object (assembly)
```

**Critical Rules**:

1. **Start at 1**, not 0
2. **No gaps** - must be sequential
3. **Container ID** must be highest number (N+1)
4. IDs must match across all files:
   - `object_1.model` object IDs
   - `3dmodel.model` component `objectid` attributes
   - `model_settings.config` part IDs

### Example with 43 regions + backing plate

```text
Objects 1-43:  Colored regions (sorted alphabetically by color)
Object 44:     Backing plate
Object 45:     Container object (references objects 1-44)
```

---

## AMS Integration

### Slot Assignment Strategy

**Goal**: Map colors to AMS slots (1-16 on Bambu Lab printers)

**Algorithm**:

1. **Slot 1**: Backing plate color (typically white)
2. **Slots 2-N**: Other unique color names in alphabetical order

**Key Insight**: Group by **color name**, not RGB values

- Multiple slightly different RGB values may map to same color name
- Example: RGB(252, 0, 0) and RGB(255, 5, 5) both map to "Red"
- They should share the same AMS slot

### Implementation

```python
# Step 1: Map backing color to slot 1
backing_color_name = get_color_name(config.backing_color, config)
name_to_slot = {backing_color_name: 1}

# Step 2: Sort regions by color name
region_data.sort(key=lambda x: x[2])  # Sort by color_name

# Step 3: Assign slots 2-N to unique color names
next_slot = 2
for _, rgb, color_name in region_data:
    if color_name not in name_to_slot:
        name_to_slot[color_name] = next_slot
        next_slot += 1
```

### Slot Metadata

**In `model_settings.config`**:

- **Slot 1**: No extruder metadata needed (default)
- **Slots 2+**: Add `<metadata key="extruder" value="{slot}"/>`

**Example**:

```xml
<!-- Slot 1: No metadata needed -->
<part id="1" subtype="normal_part">
  <metadata key="name" value="White"/>
</part>

<!-- Slot 2: Explicit extruder metadata -->
<part id="2" subtype="normal_part">
  <metadata key="name" value="Red"/>
  <metadata key="extruder" value="2"/>
</part>
```

---

## Critical Implementation Details

### 1. Container Object Pattern

**Why**: Slicers need a top-level object that groups all parts

**Pattern**:

```text
Container Object (ID = N+1)
  ├─ Empty mesh (no vertices/triangles)
  └─ Components referencing actual meshes
       ├─ Component 1 → Object 1 from object_1.model
       ├─ Component 2 → Object 2 from object_1.model
       └─ ...
```

**Without this**: Slicers may not recognize multi-object structure properly

### 2. Transform Coordination

**Three places where transforms appear**:

1. **Component transforms** (in `3dmodel.model`):
   - Position each mesh relative to model origin
   - Typically: `{model_center_x} {model_center_y} 0`

2. **Build transform** (in `3dmodel.model`):
   - Position container on build plate
   - Typically: `128 128 0` (center of 256mm bed)

3. **Assemble transform** (in `model_settings.config`):
   - Usually identity: `"1 0 0 0 1 0 0 0 1 0 0 0"`

**All three must be coordinated** for correct placement

### 3. Manifold Mesh Requirements

**Manifold Property**: Every edge shared by exactly 2 triangles

**Requirements**:

- Shared vertices between adjacent faces
- Counter-clockwise winding for outward normals
- No duplicate vertices at same position
- No degenerate triangles (zero area)

**Diagonal Pixels**: Special handling required

- Pixels touching only at corners share vertex position
- Each pixel needs **unique vertices** to maintain manifold property
- Otherwise: 4 triangles meet at single edge (non-manifold)

### 4. Coordinate Precision

**Standard**: 3 decimal places (0.001mm)

**Formatting**:

- Use `f"{value:.3f}"` for formatting
- Strip trailing zeros: `rstrip('0').rstrip('.')`
- Examples: "1.500" → "1.5", "2.0" → "2", "0.123" → "0.123"

**Why**: Prevents unnecessarily large files while maintaining precision

### 5. XML Declaration

**Format**: `<?xml version="1.0" encoding="UTF-8"?>`

**Requirements**:

- Must be first line in every XML file
- No spaces before declaration
- Encoding must be UTF-8

**Implementation**: Use `prettify_xml()` which adds this automatically

### 6. File Paths in ZIP

**Rules**:

- Use forward slashes `/` (even on Windows)
- Paths in relationships must be absolute (start with `/`)
- Paths in ZIP entries should be relative (no leading `/`)

**Example**:

```python
# ZIP entry (relative)
zf.writestr("3D/3dmodel.model", content)

# XML reference (absolute)
Target="/3D/3dmodel.model"
```

### 7. Color Naming

**Strategy**: Use color-match-tools library

1. **CSS colors** (default): Match to 147 CSS color names
2. **Filament colors**: Match to actual filament colors (Delta E 2000)
3. **Hex values**: Show as hex codes (#FF0000)

**Algorithm**: RGB → LAB → Delta E 2000 → Nearest match

**Result**: Perceptually accurate color names

### 8. Backing Plate

**Purpose**: Base layer that all colored regions sit on

**Implementation**:

- Always slot 1 in AMS
- Z-coordinate: `-base_height_mm` to `0`
- Colored regions: `0` to `color_height_mm`
- Must match exact footprint of non-transparent pixels
- Can be disabled with `base_height_mm = 0`

---

## Validation Checklist

Use this checklist to verify 3MF file correctness:

### File Structure

- [ ] File is valid ZIP archive
- [ ] Contains all required files
- [ ] Uses correct directory structure

### XML Files

- [ ] All XML files have proper declaration
- [ ] All required namespaces declared
- [ ] All XML is well-formed

### Object IDs

- [ ] Sequential starting from 1
- [ ] No gaps in numbering
- [ ] Container ID is highest number
- [ ] IDs match across all files

### Geometry

- [ ] All vertices have x, y, z attributes
- [ ] All triangles have v1, v2, v3 attributes
- [ ] Vertex indices are 0-based
- [ ] Triangles use CCW winding
- [ ] Meshes are manifold

### Transforms

- [ ] Component transforms position meshes correctly
- [ ] Build transform centers on build plate
- [ ] All transform matrices are 12 values

### AMS Review

- [ ] Backing color in slot 1
- [ ] Other colors in slots 2-N
- [ ] Colors grouped by name, not RGB
- [ ] Extruder metadata only for slots 2+

### Metadata

- [ ] Object names in model_settings.config
- [ ] Thumbnail references (if thumbnails exist)
- [ ] Title metadata set

---

## References

- **3MF Specification**: <https://github.com/3MFConsortium/spec_core>
- **Bambu Lab 3MF Extensions**: <https://wiki.bambulab.com/en/software/bambu-studio/3mf-format>
- **Color Tools Library**: <https://github.com/dterracino/color-match-tools>

---

## Version History

- **v1.0** (2025-11-27): Initial documentation based on pixel_to_3mf implementation
